!function(e){"use strict";function i(i,t){if(t.width&&t.height){var l=i.width,s=i.height,d=a+n,r=l+s,h=d/r;e("#l").val(Math.round(h*t.x1)),e("#t").val(Math.round(h*t.y1)),e("#w").val(Math.round(h*t.width)),e("#h").val(Math.round(h*t.height))}}function t(i,t){if(t.width&&t.height){var l=e("#crop").imgAreaSelect({fadeSpeed:400,handles:!0,instance:!0}),s=i.width,d=i.height,r=a+n,h=s+d,o=r/h;l.setOptions({minWidth:640/o,minHeight:640/o}),l.animateSelection(0,0,640/o,640/o,"slow",o)}}var a,n,l=function(i,t){this.$element=e(i),this.type=this.$element.data("uploadtype")||(this.$element.find(".thumbnail").length>0?"image":"file"),this.$input=this.$element.find(":file"),0!==this.$input.length&&(this.name=this.$input.attr("name")||t.name,this.$hidden=this.$element.find('input[type=hidden][name="'+this.name+'"]'),0===this.$hidden.length&&(this.$hidden=e('<input type="hidden" />'),this.$element.prepend(this.$hidden)),this.$preview=this.$element.find(".fileupload-preview"),this.$preview.css("height"),this.$element.find(".fileupload-preview.fileupload-exists.thumbnail").css("display","inline-block"),this.original={exists:this.$element.hasClass("fileupload-exists"),preview:this.$preview.html(),hiddenVal:this.$hidden.val()},this.$remove=this.$element.find('[data-dismiss="fileupload"]'),this.$element.find('[data-trigger="fileupload"]').on("click.fileupload",e.proxy(this.trigger,this)),this.listen())};l.prototype={listen:function(){this.$input.on("change.fileupload",e.proxy(this.change,this)),e(this.$input[0].form).on("reset.fileupload",e.proxy(this.reset,this)),this.$remove&&this.$remove.on("click.fileupload",e.proxy(this.clear,this))},change:function(l,s){if("clear"!==s){var d=void 0!==l.target.files?l.target.files[0]:l.target.value?{name:l.target.value.replace(/^.+\\/,"")}:null;if(!d)return e("#crop").imgAreaSelect({hide:!0}),void 0;if(this.$hidden.val(""),this.$hidden.attr("name",""),this.$input.attr("name",this.name),"image"===this.type&&this.$preview.length>0&&("undefined"!=typeof d.type?d.type.match("image.*"):d.name.match(/\.(m4a|gif|png|jpe?g)$/i))&&"undefined"!=typeof FileReader){e("#crop").imgAreaSelect({hide:!0});var r=e("#readyPreview");r.addClass("hide");var h=new FileReader,o=this.$preview,p=this.$element;h.onload=function(e){o.html('<img id="crop" src="'+e.target.result+'" '+("none"!=o.css("max-height")?'style="max-height: '+o.css("max-height")+';"':"")+" />"),p.find(".help-block").removeClass("hide"),p.find(".cropHelp").removeClass("hide"),p.find(".cropText").addClass("hide")};var u=new Image,c=window.URL||window.webkitURL;return u.onload=function(){return a=this.width,n=this.height,640>a||640>n?(p.find(".help-block p").removeClass("hide"),p.find(".cropHelp").addClass("hide"),p.find(".cropText").addClass("hide"),e("#voicesCover").val("").focus(),o.hide(),!1):(o.show(),p.find(".help-block p").addClass("hide"),e("#crop").imgAreaSelect({aspectRatio:"1:1",handles:!0,fadeSpeed:200,resizeable:!1,enable:!0,show:!0,x1:0,y1:0,x2:100,y2:100,onInit:t,onSelectChange:i,onSelectEnd:function(){var i=e("#w").val(),t=e("#h").val();return p.find(".cropHelp").addClass("hide"),640>i||640>t?(p.find(".cropText input").removeClass("rt"),p.find(".cropText").removeClass("hide"),!1):(p.find(".cropText").removeClass("hide"),p.find(".cropText input").addClass("rt"),!1)}}),void 0)},u.src=c.createObjectURL(d),h.readAsDataURL(d)}if("file"===this.type){this.$preview.text(d.name);var h=new FileReader,f=this,v=60,m=301;return h.onload=function(i){var t=new Audio,a=i.target.result;e("[data-id='voices_voice']").attr("src",a);var t=document.getElementById("voices_voice");t.src=a,t.duration,t.addEventListener("loadedmetadata",function(){console.log("wawawawa"),t.duration<v?(e.messager("音频必须在5分钟内，60秒之上。"),e("#voiceDuration").val(""),f.$input.val(""),f.$preview.html(""),f.$element.addClass("fileupload-new").removeClass("fileupload-exists")):t.duration>m?(e.messager("音频必须在5分钟内，60秒之上。"),e("#voiceDuration").val(""),f.$input.val(""),f.$preview.html(""),f.$element.addClass("fileupload-new").removeClass("fileupload-exists")):e("#voiceDuration").attr("value",t.duration)},!1),t.addEventListener("error",function(){e("#voiceDuration").val(""),e.messager("无法得到音频文件的时长,音频解析失败,请检查音频是否为AAC编码！")},!1)},h.readAsDataURL(d),!1}}},clear:function(i){if(this.$hidden.val(""),this.$hidden.attr("name",this.name),this.$input.attr("name",""),navigator.userAgent.match(/msie/i)){var t=this.$input.clone(!0);this.$input.after(t),this.$input.remove(),this.$input=t}else this.$input.val("");this.$preview.html(""),this.$element.addClass("fileupload-new").removeClass("fileupload-exists"),e("#voiceDuration").val(""),this.$element.find(".cropText").addClass("hide"),this.$element.find(".cropHelp").addClass("hide"),i&&(this.$input.trigger("change",["clear"]),i.preventDefault())},reset:function(){this.clear(),this.$hidden.val(this.original.hiddenVal),this.$preview.html(this.original.preview),this.original.exists?this.$element.addClass("fileupload-exists").removeClass("fileupload-new"):this.$element.addClass("fileupload-new").removeClass("fileupload-exists")},trigger:function(e){this.$input.trigger("click"),e.preventDefault()}},e.fn.fileupload=function(i){return this.each(function(){var t=e(this),a=t.data("fileupload");a||t.data("fileupload",a=new l(this,i)),"string"==typeof i&&a[i]()})},e.fn.fileupload.Constructor=l,e(document).on("click.fileupload.data-api",'[data-provides="fileupload"]',function(i){var t=e(this);if(!t.data("fileupload")){t.fileupload(t.data());var a=e(i.target).closest('[data-dismiss="fileupload"],[data-trigger="fileupload"]');a.length>0&&(a.trigger("click.fileupload"),i.preventDefault())}}),e.extend(e.imgAreaSelect.prototype,{animateSelection:function(i,t,a,n,l,s){var d=e.extend(e("<div/>")[0],{ias:this,start:this.getSelection(),end:{x1:i,y1:t,x2:a,y2:n}});e(d).animate({cur:1},{duration:l,step:function(i,t){var a=t.elem.start,n=t.elem.end,l=Math.round(a.x1+(n.x1-a.x1)*i),d=Math.round(a.y1+(n.y1-a.y1)*i),r=Math.round(a.x2+(n.x2-a.x2)*i),h=Math.round(a.y2+(n.y2-a.y2)*i);t.elem.ias.setSelection(l,d,r,h),t.elem.ias.update(),e("#l").val(Math.round(s*l)),e("#t").val(Math.round(s*d)),e("#w").val(Math.round(s*r)),e("#h").val(Math.round(s*h))}})}})}(window.jQuery);