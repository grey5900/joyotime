$(function(){var i,n,r;$('[data-spy="scroll"]').scrollspy("refresh");$(document).on("click",function(n){if($(n.target).is("#reply-message,#reply-submit,div.reply-placeholder,a.reply_to,a.reply"))return!0;$("#reply-form").remove(),$("div.reply-placeholder").show()});$(".timeline-adventitia").delegate(".action > .reply, .reply-placeholder","click",function(){var n=$(this),i,r,t;if($.is_signin())i=n.closest(".timeline-post"),r=$("div.reply-placeholder"),$("#reply-form").remove(),t=$('<form action="/reply/" id="reply-form" method="post" date-id="'+n.attr("date-id")+'"><input type="hidden" name="reply_id" value="'+n.attr("date-id")+'" /><input type="hidden" name="reply_to" value="'+n.attr("date-type")+'" /><input type="hidden" name="reply_uid" value="'+n.attr("date-uid")+'" /><input type="text" id="reply-message" name="message" maxlength="140" class="text" /><input type="submit" id="reply-submit" data-loading-text="……" value="发布" class="btn btn-primary" /></form>'),r.each(function(){$(this).show()}),i.find("div.reply-placeholder").hide(),i.append(t),t.show(function(){t.find("#reply-message").focus()});else return!1}),$(".timeline-adventitia").delegate(".action > .reply_to","click",function(){var n=$(this),i,r,t;if($.is_signin())i=n.closest(".timeline-post"),r=$("div.reply-placeholder"),$("#reply-form").remove(),t=$('<form action="/reply/" id="reply-form" method="post" date-id="'+n.attr("date-id")+'" date-uname="'+n.attr("date-uname")+'" date-uid="'+n.attr("date-uid")+'"><input type="hidden" name="reply_id" value="'+n.attr("date-rid")+'" /><input type="hidden" name="reply_to" value="reply" /><input type="hidden" name="reply_uid" value="'+n.attr("date-uid")+'" /><input type="text" id="reply-message" name="message" maxlength="140" autocomplete="off" class="text" /><input type="submit" id="reply-submit" data-loading-text="……" value="发布" class="btn btn-primary" /></form>'),r.each(function(){$(this).show()}),i.find("div.reply-placeholder").hide(),i.append(t),t.show(function(){t.find("#reply-message").attr("placeholder","回复"+n.attr("date-uname")).focus()});else return!1}),$(".timeline-adventitia").delegate(".action > .praise","click",function(){if($.is_signin())btn=$(this),$.ajax({type:"POST",url:"/praise/",data:{id:btn.attr("date-id"),type:btn.attr("date-target")},async:!1,cache:!1,dataType:"json",success:function(n){$("#messager").messager({message:n.msg}),n.code==1&&($("#praise_count_"+btn.attr("date-id")).plus(1),btn.text("已赞").removeClass("praise").addClass("praised").off())}});else return!1;return!1}),$(".timeline-adventitia").delegate(".action > .favorite","click",function(){if($.is_signin())btn=$(this),$.ajax({type:"POST",url:"/favorite/",data:{id:btn.attr("date-id"),type:btn.attr("date-target")},async:!1,cache:!1,dataType:"json",success:function(n){$("#messager").messager({message:n.msg}),n.code==1&&btn.text("已收藏").removeClass("favorite").addClass("favorited").off()}});else return!1;return!1}),$(".timeline-adventitia").delegate("#reply-form","submit",function(){var n=$(this),u=n.prev(".reply-placeholder"),h=n.closest(".timeline-column"),c=n.closest(".timeline-adventitia"),s=n.attr("action"),e=n.serialize(),r=n.find("#reply-message").val(),o=n.attr("date-uid"),f=n.attr("date-uname"),i=n.attr("date-id"),t;return r==""?!1:(n.remove(),u.text(r.substr(0,26)+"...").css("background-image","url(/img/loading_mini.gif)").show(),t=$("#replies-"+i),t[0]||(h.find(".post-body").after('\t\t\t\t\t<div class="reply-list hide">\t\t\t\t\t\t<a href="/review/'+i+'/" target="_blank">查看全部回复</a>\t\t\t\t\t\t<div class="reply-box">\t\t\t\t\t\t\t<ul id="replies-'+i+'"></ul>\t\t\t\t\t\t\t<div class="reply_arrow"><i class="arrow-border">◆</i><i class="arrow-inside">◆</i></div>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t'),t=$("#replies-"+i)),$.ajax({type:"POST",url:s,data:e,dataType:"json",async:!0,complete:function(){},success:function(n){if($("#messager").messager({message:n.msg}),n.code==1){var e,s="";f&&(s='回复<a href="/user/'+o+'/" target="_blank">'+f+"</a>"),e=$('\t\t\t\t\t<li class="hide">\t\t\t\t\t\t<a class="avatar small" target="_blank" href="/user/'+online_id+'/">\t\t\t\t\t\t<i></i><img alt="'+online_name+'" src="'+online_avatar+'" />\t\t\t\t\t\t</a>\t\t\t\t\t\t<div class="detail">\t\t\t\t\t\t<a target="_blank" href="/user/'+online_id+'/">您</a>'+s+'<i>：</i><span class="grayDrak">'+r+'</span>\t\t\t\t\t\t<div class="action"><span class="time">刚刚</span></div>\t\t\t\t\t\t</div>\t\t\t\t\t</li>\t\t\t\t\t'),t.append(e),t.closest(".reply-list").show(),e.fadeIn(1e3),c.find(".friangle-lt,.friangle-rt").remove().end().masonry().find(".timeline-column").each(function(){var n=$(this).css("left");n=="0px"?(html="<i class='friangle-lt'></i>",$(this).find(".feed").prepend(html)):(html="<i class='friangle-rt'></i>",$(this).find(".feed").prepend(html))}),$("#reply_count_"+i).plus(1),u.css("background-image","").text("回复内容")}}}),!1)}),i=!1,$(window).scroll(function(){i||(i=!0,setTimeout(function(){var n=$(window).data("lazyloads");n&&n.length&&($(n).each(function(){this&&$.inviewport(this,{threshold:0})&&$(this).lazyshow()}),i=!1)},250))}),$(window).trigger("scroll"),$("#timeline-now-adventitia").masonry({itemSelector:".timeline-column",isResizable:!1}).find(".timeline-column").each(function(){var n=$(this).css("left");n=="0px"?(html="<i class='friangle-lt'></i>",$(this).find(".feed").prepend(html)):(html="<i class='friangle-rt'></i>",$(this).find(".feed").prepend(html))}),n=$(".timeline-hd-title[href]"),r=10,n.lazyload();n.on("click",function(t){t.preventDefault(),n[0].scrollIntoView(!0),scrollBy(0,r)});n.next().masonry({itemSelector:".timeline-column",isResizable:!1});var f=$("#timebar"),u=$("#timebar").length&&$("#timebar").offset().top,t=0;$(window).on("scroll",function(){var i,n=$(window).scrollTop();n>=u&&!t?(t=1,f.addClass("fixed")):n<=u&&t&&(t=0,f.removeClass("fixed"))});$(".nav li > a").click(function(){var t=$(this).attr("href"),n=$(t).offset().top;return $("html,body").animate({scrollTop:n},200),!1}),$("#returntop").returntop()})