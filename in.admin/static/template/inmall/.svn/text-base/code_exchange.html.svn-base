{eval $page_rel='code_exchange';}
<div class="pageContent" id="{$page_rel}">
	兑换码：
	<input type="text" name="code" />
	<button type="button" name="validate"> 验 证 </button>
	<br/>
	<div id="info_{$page_rel}" style="display:none">
	    <table class="list" width="100%">
	    	<tr>
	    		<td colspan="5">
	    		<span name="code"></span>
	    		<span name="status"></span>
	    		<span name="date"></span>
	    		</td>
	    	</tr>
	        <tr>
	            <td width="10%">商品ID</td>
	            <td width="40%">商品名</td>
	            <td width="10%">商品单价</td>
	        	<td width="15%">订单号</td>
	        	<td width="25%">购买人信息</td>
	        </tr>
	        <tr>
	            <td name="product_id"></td>
	            <td name="product_name"></td>
	            <td name="product_price"></td>
	        	<td name="order_id"></td>
	        	<td name="buyer"></td>
	        </tr>
	        <tr>
	        	<td colspan="5">
	        		<button style="display:none;" name="exchange">立即兑换</button>
	        		<span name="ext_info"></span>
	        	</td>
	        </tr>
	    </table>
    </div>
</div>
<script type="text/javascript">
$(function(){
	$("button[name=validate]", "#{$page_rel}").on("click", function(){
		var code = $.trim($("input[name=code]", "#{$page_rel}").val());
		if(code == "") {
			alertMsg.error("请输入兑换码");
			return;
		}
		
		$("#info_{$page_rel}").hide();
		$("button[name=exchange]", "#{$page_rel}").hide();
		$("span[name=ext_info]", "#info_{$page_rel}").text("");
		
		$.getJSON("/inmall/exchange/code/" + encodeURIComponent(code), function(json){
			if(json.code == 0) {
				var data = json.data;
				$("span[name=code]", "#info_{$page_rel}").text(data.code);
				$("span[name=date]", "#info_{$page_rel}").text(data.date);
				var span_status = $("span[name=status]", "#info_{$page_rel}");
				span_status.removeClass();
				switch(data.status) {
					case 0:
						console.log(data.status);
						$("button[name=exchange]", "#{$page_rel}").show();
						span_status.addClass("tip_green");
						span_status.text("未兑换");
						break;
					case 1:
						console.log(data.status);
						span_status.addClass("tip_red");
						span_status.text("已兑换");
						break;
					case 2:
						console.log(data.status);
						span_status.addClass("tip_grey");
						span_status.text("已过期");
						break;
				}
				$("td[name=product_id]", "#info_{$page_rel}").text(data.product_id);
				$("td[name=product_name]", "#info_{$page_rel}").text(data.product_name);
				$("td[name=product_price]", "#info_{$page_rel}").text(data.product_price);
				$("td[name=order_id]", "#info_{$page_rel}").html(data.order_id + " <a href=\"javascript:;\" onclick=\"open_order_detail(" + data.order_id + ")\">查看<\/a>");
				$("td[name=buyer]", "#info_{$page_rel}").text("(" + data.uid + ")" + data.nickname + " " + data.cellphoneNo);
				
				if(data.code_type == "1") {
					$("button[name=exchange]", "#{$page_rel}").hide();
					$("span[name=ext_info]", "#info_{$page_rel}").text("此码为手动导入的第三方兑换码");
				}
				
				$("#info_{$page_rel}").show();
			} else {
				// 失败
				alertMsg.error(json.message);
			}
		});
	});
	
	// 兑换
	$("button[name=exchange]", "#{$page_rel}").on("click", function(){
		if(!confirm("您确定要兑换该码？")) {
			return;
		}
	
		var code = $.trim($("span[name=code]", "#info_{$page_rel}").text());
		if(code == "") {
			alertMsg.error("请输入兑换码");
			return;
		}
		$.getJSON("/inmall/exchange/do/yes/code/" + encodeURIComponent(code), function(json){
			if(json.code == 0) {
				$("#info_{$page_rel}").hide();
				$("button[name=exchange]", "#{$page_rel}").hide();
				alertMsg.correct(json.message);
			} else {
				alertMsg.error(json.message);
			}
		});
	});
});

/**
 * 打开订单详情
 * @param {} order_id
 * @returns {} 
 */
function open_order_detail(order_id) {
	navTab.openTab("inmall_order_detail", "/inmall/order_detail/id/" + order_id, {title:"订单详情"});
}
</script>