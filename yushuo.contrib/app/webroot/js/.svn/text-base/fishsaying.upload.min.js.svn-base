!function(e){"use strict";function t(t,n){if(n.width&&n.height){var s=t.width,o=t.height,l=i+a,d=s+o,r=l/d;e("#l").val(Math.round(r*n.x1)),e("#t").val(Math.round(r*n.y1)),e("#w").val(Math.round(r*n.width)),e("#h").val(Math.round(r*n.height))}}var i,a,n=function(t,i){this.$element=e(t),this.type=this.$element.data("uploadtype")||(this.$element.find(".thumbnail").length>0?"image":"file"),this.$input=this.$element.find(":file"),0!==this.$input.length&&(this.name=this.$input.attr("name")||i.name,this.$hidden=this.$element.find('input[type=hidden][name="'+this.name+'"]'),0===this.$hidden.length&&(this.$hidden=e('<input type="hidden" />'),this.$element.prepend(this.$hidden)),this.$preview=this.$element.find(".fileupload-preview"),this.$preview.css("height"),this.original={exists:this.$element.hasClass("fileupload-exists"),preview:this.$preview.html(),hiddenVal:this.$hidden.val()},this.$remove=this.$element.find('[data-dismiss="fileupload"]'),this.$element.find('[data-trigger="fileupload"]').on("click.fileupload",e.proxy(this.trigger,this)),this.listen())};n.prototype={listen:function(){this.$input.on("change.fileupload",e.proxy(this.change,this)),e(this.$input[0].form).on("reset.fileupload",e.proxy(this.reset,this)),this.$remove&&this.$remove.on("click.fileupload",e.proxy(this.clear,this))},change:function(n,s){var o=e("#crop"),l=e("#readyPreview");if("clear"!==s){var d=void 0!==n.target.files?n.target.files[0]:n.target.value?{name:n.target.value.replace(/^.+\\/,"")}:null;if(!d)return this.clear(),void 0;if(o.imgAreaSelect({hide:!0}),l.addClass("hide"),this.$hidden.val(""),this.$hidden.attr("name",""),this.$input.attr("name",this.name),"image"===this.type&&this.$preview.length>0&&("undefined"!=typeof d.type?d.type.match("image.*"):d.name.match(/\.(m4a|gif|png|jpe?g)$/i))&&"undefined"!=typeof FileReader){var r=new FileReader,h=this.$preview,p=this.$element;e("#voicesCover"),r.onload=function(e){h.html('<img id="crop" src="'+e.target.result+'" '+("none"!=h.css("max-height")?'style="max-height: '+h.css("max-height")+';"':"")+" />"),p.find(".help-block").removeClass("hide"),p.find(".cropHelp").removeClass("hide")};var c=window.URL||window.webkitURL,m=new Image;m.onload=function(){return i=this.width,a=this.height,640>i||640>a?(p.find(".help-block p").removeClass("hide"),p.find(".cropHelp").addClass("hide"),p.find(".cropText").addClass("hide"),$voicesCover.val("").focus(),h.hide(),!1):(h.show(),p.find(".help-block p").addClass("hide"),o.imgAreaSelect({aspectRatio:"1:1",handles:!0,fadeSpeed:200,resizeable:!1,show:!0,onSelectChange:t,x1:0,y1:0,x2:100,y2:100,onSelectEnd:function(){var t=e("#w").val(),i=e("#h").val();return p.find(".cropHelp").addClass("hide"),640>t||640>i?(p.find(".cropText input").removeClass("rt"),p.find(".cropText").removeClass("hide"),!1):(p.find(".cropText").removeClass("hide"),p.find(".cropText input").addClass("rt"),!1)}}),void 0)},m.onerror=function(){},m.src=c.createObjectURL(d),r.readAsDataURL(d)}else{if("file"===this.type){this.$preview.text(d.name);var r=new FileReader,u=this;return r.onload=function(t){var i=e("#voices_voice"),a=t.target.result,n=i[0];return i.attr("src",a),n.addEventListener("loadedmetadata",function(){return n.duration<60?(e.messager("音频必须在5分钟内，60秒之上。"),e("#voiceDuration").val(""),u.$input.val(""),u.$preview.html(""),!1):n.duration>300?(e.messager("音频必须在5分钟内，60秒之上。"),e("#voiceDuration").val(""),u.$input.val(""),u.$preview.html(""),!1):(e("#voiceDuration").attr("value",n.duration),void 0)})},r.readAsDataURL(d),void 0}this.$preview.text(d.name)}}},clear:function(t){if(this.$hidden.val(""),this.$hidden.attr("name",this.name),this.$input.attr("name",""),navigator.userAgent.match(/msie/i)){var i=this.$input.clone(!0);this.$input.after(i),this.$input.remove(),this.$input=i}else this.$input.val("");this.$preview.html(""),this.$element.addClass("fileupload-new").removeClass("fileupload-exists"),e("#voiceDuration").val(""),this.$element.find(".cropText").addClass("hide"),this.$element.find(".cropHelp").addClass("hide"),t&&(this.$input.trigger("change",["clear"]),t.preventDefault())},reset:function(){this.clear(),this.$hidden.val(this.original.hiddenVal),this.$preview.html(this.original.preview),this.original.exists?this.$element.addClass("fileupload-exists").removeClass("fileupload-new"):this.$element.addClass("fileupload-new").removeClass("fileupload-exists")},trigger:function(e){this.$input.trigger("click"),e.preventDefault()}},e.fn.fileupload=function(t){return this.each(function(){var i=e(this),a=i.data("fileupload");a||i.data("fileupload",a=new n(this,t)),"string"==typeof t&&a[t]()})},e.fn.fileupload.Constructor=n,e(document).on("click.fileupload.data-api",'[data-provides="fileupload"]',function(t){var i=e(this);if(!i.data("fileupload")){i.fileupload(i.data());var a=e(t.target).closest('[data-dismiss="fileupload"],[data-trigger="fileupload"]');a.length>0&&(a.trigger("click.fileupload"),t.preventDefault())}})}(window.jQuery);